# Краткий мануал по использованию редактора шаблонов (TemplateEditor.exe)

Данное руководство не претендует на истину в последней инстанции и составлено пользователем, практикующим метод активного тыка. Однако, исчерпывающая инструкция в природе отсутствует, поэтому иного метода освоения шаблонов, кроме метода проб и ошибок, не предвидится в будущем. По слухам, полная инструкция может получиться в объёме, который проблематично усвоить среднестатистическому человеку.

Для краткости и подъёма настроения, редактор шаблонов далее называется "шмудактором" :) А редактор миссий - просто редактор.
Шмудактор создаёт и изменяет текстовые файлы формата *.mt (mission template).
Шмудактор работает с папками в папке игра/data/scg, причём одновременно только с одной из папок. По сложившейся практике, папки театров военных действий (ТВД) именуются числами 1, 2, 3 и т.д.

## Конфигурация

__В первую очередь__ шмудактору нужен файл data/scg/TemplateEditor.ini примерно следующего содержания:

```text
tvd = "scg\2";
models = "models.cfg";
actions = "actions.cfg";
blocks = "blocks_quickmission\airfields_red";
blocks = "blocks_quickmission\airfields_blue";
blocksINI = "scg\2\blocksFolder.ini"
```

tvd - это папка, с которой работает шмудактор (при редактировании шаблона, который лежит не в текущей рабочей папке, могут возникнуть проблемы)

models - имя файла с описанием моделей игровых объектов (техники, самолётов и т.п.)

actions - имя файла с описанием доступных условных действий, выполняемых при генерации миссии по шаблону и параметрам генерации (в шаблоне из описанных в этом файле действий выбираются нужные)

blocks - перечисление папок координатных групп (каждая папка должна содержать однотипные группы с именами файлов в формате !x00000z99999.Group, где 00000 - координата расположения группы по оси X игрового мира 99999 - координата Z)

__Во вторую очередь__ шмудактору нужен файл blocksFolder.ini, указанный в TemplateEditor.ini, желательно лежащий в папке ТВД и обязательно содержащий перечисление всех координатных групп во всех папках. Например, для одной папки:

```text
[blocksfolder = blocks_quickmission\airfields_red]
    block = "z_!1","!x79485z11667.Group"
    block = "z_!2","!x96331z50292.Group"
    block = "z_!3","!x93653z54575.Group"
    // и т.д. ...
[end]
```

Остальные папки с координатными группами описываются в этом же файле в подобных секциях, обозначенных заголовком и end в квадратных скобках [ ]. В заголовке указывается папка координатных групп.

## Группы

Это файлы с расширением .Group.
Шмудактор "видит" группы в папке ТВД и их можно создавать/менять с помощью редактора. Для этого надо выбрать что-то в редакторе и через меню по правому клику нажать на Save Selection to File.
После добавления новых групп шмудактор надо перезапускать, чтобы он их "увидел".
После изменения "входов" и "выходов" существующих групп надо в шмудакторе выбрать в меню Edit -> Reload on the fly. Тогда шмудактор обновит динамики, входы и выходы у фаз, соответствующих изменённым группам.
__В группе обязательно должен присутствовать `Helper:Reference Point`__.

`Группа - это материал для генератора, из которого он собирает миссию. А шаблон - это инструкция по сборке`. По существу, группа - это заготовка из расставленных объектов и некоторая логика из MCU, связанная с этими объектами. Генератор поставит эту группу в указанную шаблоном локацию. Одну группу можно использовать сколько угодно раз в шаблонах. Вокруг групп и связанных с ними фаз и построена вся генерация миссий.

## Локации

Генератор использует так называемую "базу локаций" - файл .ldf, скомпилированный утилитой `make_ldb` в файл .ldb (make_ldb конвертирует текстовый файл в бинарный для скорости работы генератора).
База локаций создаётся в редакторе и состоит из объектов категории `Location`. Её необходимо открывать и сохранять через меню `Location Database` в редакторе.

Сами локации бывают разных типов, а каждый тип может принадлежать к одному или более видов. Например:
Тип локации - `GroundObjective` (наземная цель), виды: `Tank`, `Artillery`. Это означает, что в данную локацию можно поставить группу, у фазы которой задана проверка по типу локации GroundObjective и виду Tank `или` Artillery.

Таким образом можно в генерируемой миссии получать какие угодно комбинации техники, самолётов и любых других объектов, доступных в редакторе. _Однако, все случайности не случайны_. База локаций - это `конечное` множество точек и при тысячах локаций обслуживать её становится проблематично.

## Хелперы (сейчас будет сложно)

Сначала некоторые определения, которые важно понимать, чтобы освоить механизм работы (простите за занудство).

`Сущности` - это любой игровой объект, с которым связана "сущность" (Искусственный интеллект, если хотите). Когда в редакторе нажимается кнопка "Create linked entity", происходит создание "сущности" объекта, что позволяет ему взаимодействовать с логикой миссии (MCU: триггеры, команды и т.п.)

`Триггер/MCU` - это объект игровой логики, на основе которых строится управление миссией в зависимости от событий, происходящих по её ходу.

`Связь/линк` - это целевая или объектная связь в терминах редактора.

`Розетки/входы/выходы` - это имена и направление связей входящих или выходящих из группы для соединения групп генератором (далее станет понятно их применение). В редакторе это Helper:Input и Helper:Output.

`Динамик` - это вспомогательный объект редактора, в котором перечисляются свойства MCU или сущностей, задаваемые генератором. Соответствующие настройки появляются у фазы группы в шмудакторе. Динамик надо соединить целевой связью с объектом, который будет настраиваться в шаблоне. В редакторе это Helper:Dynamic.

`Helper: Reference Point` - он задаёт центр вращения группы, относительно которого выполняется поворот группы при установке в локацию.

`Позиция` - какая-то точка в игровом мире с координатами X(широта), Z(долгота).

### Что если надо связать игровой логикой две группы? Например, чтобы сгенерировать маршрут колонне

Для этого необходимо, чтобы в миссии между Trigger:Waypoint и колонной была объектная связь.
Эту задачу решают `розетки`. Чтобы создать вход, надо добавить в группу Helper:Input. Розетка будет иметь то же имя, что и Helper:Input. Для удобства, лучше задавать своё имя. Соответственно, для создания выхода надо создать Helper:Output.

В шмудакторе соединение розеток задаётся выбором двух соответствующих фаз мышью с зажатым Ctrl и кликом правой кнопкой мыши. В контекстном меню появляются пункты для соединения входов и выходов целевой или объектной связью.

Итак, чтобы создать колонну с генерируемым маршрутом, надо:

1. Создать группу маршрутной точки с Trigger:Waypoint, Helper:Input внутри и объектной связью от входного триггера к маршрутной точке.
1. Создать группу самой колонны и от её головной машинки добавить объектную связь на выходной триггер (Helper:Output).
1. Добавить начальную фазу шаблона (Server Set pos или Server Target pos)
1. Добавить обе группы как фазы в шаблон. (Не забывать указывать Primary link у фаз!)
1. Задать правила расстановки фаз в локации (правый клик при выбранной фазе показывает меню добавления правил расстановки).
1. Соединить розетки фаз. Для удобства это можно сделать кликом с зажатым Shift. Выходы выбранной фазы будут соединены __целевой связью__ с одноимёнными(!) входами той, по которой кликнуть. Если добавить _OBJECT к имени розеток, то автоматическое соединение будет __объектной связью__.

При некоторой практике этот простой алгоритм действий отрабатывается до автоматизма :)

### Можно использовать универсальную группу для любой стороны

Для этого нужны `динамики`. Ставим в группу любую технику с сущностью и цепляем на неё динамик (целевая связь из динамика в объект). В динамике выбираем Country в true (двойной клик по соответствующей строчке). Когда добавим фазу группы в шаблон, у неё появится настройка для соответствующего объекта.

Если таким образом изменили существующую группу, то в шмудакторе Edit -> Reload Blocks on the fly. Предварительно лучше сделать резервную копию шаблона, вдруг сломается.

### Да можно вообще любые параметры объекта задавать в шаблоне

А надо ли? Это уже вопрос удобства и сокращения трудозатрат. Если что-то можно сделать один раз, чтобы потом не копировать - лучше сделать так. Но это усложняет "кастомизацию", если, например, захочется к пушке добавить статический опель/полуторку. Хелперы не действуют на объекты без сущности.

## Фазы

Фаза добавляется в шаблон используя шмудактор двойным кликом. Все фазы именуются ПРОПИСНЫМИ_БУКВАМИ_БЕЗ_ПРОБЕЛОВ.

Фаза может быть одного из 2х типов, который задаётся при создании фазы и не может изменяться в шмудакторе после её создания:

* Main Block - фаза с обычной группой, закреплённой за ней
* Blocks Folder - фаза с координатной группой

Тип генерации (Generation Type) - это способ определения локации/позиции фазы при генерации. У двух типов генерации: Server Set position и Server Target position фиксированные координаты, которые задаются в параметрах генерации. Для Server Set: $xposition и $zposition, для Server Target: $xtargetposition и $ztargetposition.

Для всех остальных типов генерации обязательно указывать Primary link. Фазы без Primary link не генерируются. Primary link устанавливается в настройках фазы, либо по клику на родительскую фазу после нажатия Ctrl+T. У двух Primary link нет, их координаты фиксированы и задаются в файле параметров генерации.

Также есть типы генерации, где ещё требуется Secondary link.

Координаты всех фазы с типом генерации, требующим Primary или Secondary link, определяются относительно фаз, которые указаны как Primary, Secondary, соответственно. Какой тип и как использовать, надо определять методом проб и ошибок, либо у кого-нибудь спросить, кто знает.

У меня наиболее ходовой тип - Random, т.е. случайная локация относительно Primary.
Line - это по линии, проходящей через Primary и Secondary фазы (так можно "разворачивать" фазы "лицом" на другие).
Azimuth - это со смещением по азимуту.

### Правила

У фазы могут быть правила генерации - ограничения, накладываемые на выбор локаций, т.к. Random без ограничений может поставить вообще в абсолютно любую локацию из базы локаций. Они задаются через Add ... check по правому клику с выбранной фазой. Далее смысл этих ограничений:

* Free - выбирать только локации, которые ещё не заняты другими фазами (проверка, вроде, логическая, не координатная, т.е. если 2 одинаковых локации с одними координатами - то проверка может быть бесполезной, хотя это не проверялось :) ).
* Coalition - только локации указанной коалиции.
* Location Type - только локации указанного вида+типа.
* Range - ближайшая к primary локация, но не ближе чем указанное значение. (проверка несовместима с In Radius)
* In Radius - случайная локация в заданном радиусе от primary.

## Координатные группы

Это группы, которые ставятся строго в заданные координаты, когда локация с этими координатами выбирается для генерации. Например, выбралась для фазы типа Blocks Folder, локация с координатами x=123, z=321. Тогда генератор прочитает папку, заданную при создании фазы и найдёт там группу, в имени файла которой указаны ближайшие координаты к x=123, z=321. Эту группу он и поставит в локацию с координатами x=123, x=321.
Такие группы нужны, например, для аэродромов, потому что это уникальные объекты, которые не повторяются на карте. Впрочем, если оставить стандартные землянки и отказаться от имён точек спауна, то можно обойтись и без этого.

## Параметры генерации

Это файл, содержащий строки вида

```text
$xposition = 230400
$zposition = 358400
$tvd = scg\1\
```

## Лог

Генератор при запуске из консоли выдаёт лог генерации, вдумчиво прочитав который, можно понять, почему группы ставятся в координаты x=0, z=0. Обычно бывает, что не хватает локаций, удовлетворяющих заданным правилам (кривые настройки шаблона или криво поставленная локация).

Удобно этот лог сохранять куда-нибудь в файл. При вызове из консоли надо перенаправить вывод программы в файл таким добавлением к вызову программы MissionGen.exe: " > log.txt". Например

>MissionGen.exe путь_к_файлу_параметров_генерации путь_к_файлу_шаблона > log.txt
